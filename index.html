<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FluentBiz | Smart Business Dashboard</title>

  <!-- Fonts & Chart.js -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --purple:#6C63FF; --blue:#2575FC; --bg:#f7f9ff; --card:#ffffff; --muted:#6b7280;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f3f6ff,#eef2ff);color:#0f172a}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,var(--purple),var(--blue));color:#fff;position:sticky;top:0;z-index:40}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{font-weight:700;font-size:18px;letter-spacing:0.6px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .lang-btn, .notif-btn{background:transparent;border:0;color:#fff;cursor:pointer;padding:8px;border-radius:8px}
    .app{display:flex;gap:20px;max-width:1200px;margin:22px auto;padding:0 16px}
    .sidebar{width:250px;min-width:220px;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.85));border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(15,23,42,0.06);height:calc(100vh - 120px);position:sticky;top:80px}
    .sidebar h3{margin:4px 0 12px 0;color:var(--purple)}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;cursor:pointer;color:#0f172a}
    .nav-item:hover{background:rgba(37,99,235,0.06)}
    .nav-item.active{background:linear-gradient(90deg,var(--purple),var(--blue));color:#fff}
    .main{flex:1}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(15,23,42,0.06);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .hero{display:flex;gap:20px;align-items:center;background:linear-gradient(135deg,rgba(108,99,255,0.12),rgba(37,117,252,0.08));padding:18px;border-radius:12px}
    .hero .logoBig{font-size:28px;font-weight:800;color:var(--purple)}
    .cta{display:flex;gap:10px;margin-top:12px}
    .btn{padding:8px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--purple),var(--blue));color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eefc;width:100%;}
    .center-wrap{display:flex;align-items:center;justify-content:center;height:calc(100vh - 140px)}
    .login-box{width:420px;padding:22px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(255,255,255,0.8));box-shadow:0 10px 40px rgba(2,6,23,0.08)}
    .small{font-size:13px;color:var(--muted)}
    .mobile-nav{display:none;position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.95);padding:8px;border-radius:40px;box-shadow:0 8px 22px rgba(2,6,23,0.08)}
    .mobile-nav button{background:transparent;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
    @media(max-width:920px){
      .app{flex-direction:column;padding-bottom:120px}
      .sidebar{width:100%;height:auto;position:relative;top:0}
      .mobile-nav{display:flex;gap:8px}
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef3ff;text-align:left}
    .muted-pill{background:#f1f5f9;padding:4px 8px;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logoBig" style="color:white">FluentBiz</div>
      <div class="small" style="color:rgba(255,255,255,0.9)">Empowering Global Sellers & Businesses</div>
    </div>
    <div class="top-actions">
      <button class="lang-btn" id="langToggle">ID</button>
      <button class="notif-btn" id="notifBtn">üîî</button>
      <div id="userMenu" style="color:#fff;font-weight:600">Guest</div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar card" id="sidebar">
      <h3>Menu</h3>
      <div class="nav-item active" data-page="home" onclick="navigate('home')">üè† Home</div>
      <div class="nav-item" data-page="integrations" onclick="navigate('integrations')">üîó Integrations</div>
      <div class="nav-item" data-page="dashboard" onclick="navigate('dashboard')">üìä Dashboard</div>
      <div class="nav-item" data-page="subscriptions" onclick="navigate('subscriptions')">üí≥ Subscriptions</div>
      <div class="nav-item" data-page="settings" onclick="navigate('settings')">‚öôÔ∏è Settings</div>
      <div class="nav-item" data-page="support" onclick="navigate('support')">üí¨ Support</div>
      <div style="height:10px"></div>
      <div style="margin-top:8px"><button class="btn primary" id="startNow" onclick="navigate('login')">Start Now</button></div>
    </aside>

    <main class="main">
      <!-- HOME -->
      <section id="home" class="card page active">
        <div class="hero">
          <div style="flex:1">
            <div style="font-size:20px;font-weight:700;color:var(--purple)">Satu Platform. Semua Data Bisnis.</div>
            <h1 style="margin-top:6px">FluentBiz ‚Äî Smart Business Dashboard</h1>
            <p class="small" style="margin-top:8px;max-width:640px">FluentBiz menggabungkan marketplace, sistem perusahaan dan aplikasi digital ke dalam satu dashboard cerdas. Analitik, laporan, dan automasi ‚Äî semuanya mudah diakses.</p>
            <div class="cta">
              <button class="btn primary" onclick="navigate('login')">Mulai Sekarang</button>
              <button class="btn ghost" onclick="navigate('integrations')">Lihat Integrations</button>
            </div>
            <div style="margin-top:10px;">
              <span class="muted-pill">Trial 7 hari</span>
              <span class="muted-pill" id="userRolePill" style="margin-left:8px">Role: Guest</span>
            </div>
          </div>
          <div style="width:360px">
            <div style="background:linear-gradient(90deg,rgba(108,99,255,0.08),rgba(37,117,252,0.06));padding:12px;border-radius:12px">
              <h3 style="margin:0">Visi & Misi</h3>
              <p class="small" style="margin-top:6px">Visi: Menjadi pusat data bisnis global. Misi: Mempermudah integrasi & menampilkan insight yang bermakna.</p>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="grid">
          <div class="card">
            <h4>Untuk Seller Online</h4><p class="small">Pantau penjualan, stok, dan performa listing dari Shopee, Tokopedia, Lazada, dan TikTok Shop.</p>
          </div>
          <div class="card">
            <h4>Untuk Perusahaan</h4><p class="small">Laporan cabang, produksi, dan KPI untuk manajemen senior.</p>
          </div>
          <div class="card">
            <h4>Untuk Aplikasi</h4><p class="small">Analitik DAU, retention, dan revenue untuk aplikasi & game.</p>
          </div>
        </div>
      </section>

      <!-- INTEGRATIONS -->
      <section id="integrations" class="card page" style="display:none">
        <h2>Integrations</h2>
        <p class="small">Hubungkan marketplace atau sistem perusahaan. (Demo: klik connect untuk simulasi)</p>
        <div class="grid" style="margin-top:12px">
          <div class="card">
            <h4>Shopee</h4><p class="small">Partner API / OAuth</p>
            <button class="btn primary" onclick="simulateConnect('shopee')">Connect Shopee</button>
            <div id="status-shopee" class="small" style="margin-top:8px;color:green"></div>
          </div>
          <div class="card">
            <h4>Tokopedia</h4><p class="small">Partner API / OAuth</p>
            <button class="btn primary" onclick="simulateConnect('tokopedia')">Connect Tokopedia</button>
            <div id="status-tokopedia" class="small" style="margin-top:8px;color:green"></div>
          </div>
          <div class="card">
            <h4>Lazada</h4><p class="small">Open Platform</p>
            <button class="btn primary" onclick="simulateConnect('lazada')">Connect Lazada</button>
            <div id="status-lazada" class="small" style="margin-top:8px;color:green"></div>
          </div>
          <div class="card">
            <h4>TikTok Shop</h4><p class="small">Partner API</p>
            <button class="btn primary" onclick="simulateConnect('tiktok')">Connect TikTok Shop</button>
            <div id="status-tiktok" class="small" style="margin-top:8px;color:green"></div>
          </div>
          <div class="card">
            <h4>Perusahaan (ERP / CSV)</h4><p class="small">Upload CSV / Connect ERP</p>
            <input type="file" id="uploadCsv" accept=".csv" />
            <button class="btn primary" onclick="simulateConnect('company')">Connect Company</button>
            <div id="status-company" class="small" style="margin-top:8px;color:green"></div>
          </div>
          <div class="card">
            <h4>Aplikasi (SDK / API)</h4><p class="small">Connect App Analytics</p>
            <button class="btn primary" onclick="simulateConnect('app')">Connect App</button>
            <div id="status-app" class="small" style="margin-top:8px;color:green"></div>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard" class="page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h2>Dashboard</h2>
            <div class="small" id="dash-sub">Ringkasan performa</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="small">Trial sisa: <strong id="trialDays">‚Äî</strong></div>
            <button class="btn ghost" onclick="openSubscribe()">Upgrade</button>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="card">
            <h4>Total Sales</h4>
            <div id="totalSales" style="font-weight:700;font-size:20px">‚Äî</div>
            <div class="small">Periode: last 30 days</div>
          </div>
          <div class="card">
            <h4>Active Customers</h4>
            <div id="activeUsers" style="font-weight:700;font-size:20px">‚Äî</div>
            <div class="small">Realtime & historical</div>
          </div>
          <div class="card">
            <h4>Orders Completed</h4>
            <div id="ordersCompleted" style="font-weight:700;font-size:20px">‚Äî</div>
            <div class="small">Shipping & returns</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Sales Trend</h4>
          <canvas id="salesTrend" height="120"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Platform Mix</h4>
          <canvas id="platformMix" height="80"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Autopilot Insights (Demo)</h4>
          <p class="small">Autopilot akan menjalankan analisis berkala, mendeteksi tren, dan membuat rekomendasi.</p>
          <div id="autopilotLog" class="small" style="max-height:120px;overflow:auto;background:#fbfdff;padding:8px;border-radius:8px;margin-top:8px">No autopilot runs yet.</div>
          <div style="margin-top:8px">
            <button class="btn ghost" onclick="runAutopilotNow()">Run Now</button>
            <button class="btn primary" id="autopilotToggle" onclick="toggleAutopilot()">Enable Autopilot</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Recent Transactions</h4>
          <table><thead><tr><th>ID</th><th>Date</th><th>Customer</th><th>Total</th></tr></thead><tbody id="recentTx"></tbody></table>
        </div>
      </section>

      <!-- SUBSCRIPTIONS -->
      <section id="subscriptions" class="card page" style="display:none">
        <h2>Subscriptions & Billing</h2>
        <p class="small">Coba free 7 hari. Untuk production, integrasikan Stripe atau Midtrans untuk payment gateway dan verifikasi webhook.</p>
        <div style="display:flex;gap:12px;margin-top:12px">
          <div class="card" style="flex:1">
            <h4>Free</h4><p class="small">Trial 7 hari ‚Äî fitur dasar</p><button class="btn ghost" onclick="startFree()">Start Free</button>
          </div>
          <div class="card" style="flex:1">
            <h4>Pro</h4><p class="small">Advanced analytics, API access, priority support</p><button class="btn primary" onclick="startPro()">Subscribe Pro</button>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="card page" style="display:none">
        <h2>Settings</h2>
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label class="small">Name</label><input id="profileName" placeholder="Your name" />
            <label class="small" style="margin-top:8px">Language</label>
            <select id="langSelect"><option value="id">Indonesia</option><option value="en">English</option></select>
            <div style="margin-top:12px"><button class="btn primary" onclick="saveProfile()">Save</button></div>
          </div>
          <div style="flex:1">
            <h4>Integration status</h4><div id="integrationList" class="small">No active integrations</div>
            <div style="margin-top:12px"><button class="btn ghost" onclick="disconnectAll()">Disconnect All</button></div>
          </div>
        </div>
      </section>

      <!-- SUPPORT -->
      <section id="support" class="card page" style="display:none">
        <h2>Customer Support</h2>
        <p class="small">Kirim tiket atau request integrasi.</p>
        <textarea id="supportText" rows="6" placeholder="Describe your issue..." style="width:100%;margin-top:8px"></textarea>
        <div style="margin-top:8px"><button class="btn primary" onclick="sendTicket()">Send Ticket</button></div>
      </section>

      <!-- LOGIN -->
      <section id="login" class="page" style="display:none">
        <div class="center-wrap">
          <div class="login-box">
            <h3 style="margin:0">Login to FluentBiz</h3>
            <p class="small">Use your email & password</p>
            <label class="small">Email</label><input id="loginEmail" type="email" placeholder="email@domain.com" />
            <label class="small">Password</label><input id="loginPass" type="password" placeholder="password" />
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn primary" id="loginBtn">Login</button>
              <button class="btn ghost" onclick="navigate('home')">Cancel</button>
            </div>
            <p id="loginError" class="small" style="color:crimson;margin-top:8px;display:none"></p>
            <p class="small" style="margin-top:8px">Don't have account? <a href="#" onclick="createDemoAccount()">Create demo account</a></p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="mobile-nav card">
    <button onclick="navigate('home')">üè†</button>
    <button onclick="navigate('dashboard')">üìä</button>
    <button onclick="navigate('integrations')">üîó</button>
    <button onclick="navigate('support')">üí¨</button>
  </div>

<script type="module">
// ====== CONFIG: paste your Firebase config and backend keys here ======
const firebaseConfig = { /* paste your firebaseConfig here for production */ };
const BACKEND_BASE_URL = 'https://YOUR_REGION-YOUR_PROJECT.cloudfunctions.net/api'; // replace later
const STRIPE_PUBLIC_KEY = ''; // replace when integrate
// =====================================================================

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

let app, auth, db;
try{
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch(e){
  console.warn('Firebase not initialized ‚Äî paste your firebaseConfig in the file to enable Auth/Firestore.', e);
}

// ======= Helpers =======
function el(id){ return document.getElementById(id); }
function daysBetween(a,b){ return Math.ceil((b-a)/(1000*60*60*24)); }
function daysLeftFrom(startTs, days=7){
  if(!startTs) return days;
  const s = new Date(startTs).getTime();
  const now = Date.now();
  const left = days - Math.floor((now - s)/(1000*60*60*24));
  return left < 0 ? 0 : left;
}
function formatRp(n){ try{return 'Rp '+Number(n).toLocaleString('id-ID'); }catch(e){return n;} }

// ======= Navigation =======
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const elpage = document.getElementById(page);
  if(elpage) elpage.style.display = 'block';
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const navEl = document.querySelector(`.nav-item[data-page="${page}"]`);
  if(navEl) navEl.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}
window.navigate = navigate;

// ======= Auth (demo-friendly) =======
if(typeof auth !== 'undefined'){
  onAuthStateChanged(auth, async user=>{
    if(user){
      el('userMenu').innerText = user.email.split('@')[0];
      const uref = doc(db,'users',user.uid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        await setDoc(uref,{ email:user.email, role:'seller', trialStart: serverTimestamp(), isPremium:false, integrations:{} });
      }
      const data = (await getDoc(uref)).data();
      const integrations = data.integrations || {};
      const hasIntegration = Object.keys(integrations).length > 0;
      el('userRolePill').innerText = 'Role: '+(data.role||'seller');
      if(!hasIntegration){
        navigate('integrations');
      } else {
        navigate('dashboard');
        await populateIntegrationList();
        loadDashboardForRole(data.role || 'seller', data);
        startAutopilotIfEnabled();
      }
    } else {
      el('userMenu').innerText = 'Guest';
      // show stored trial info if any
      navigate('home');
      updateTrialUI();
    }
  });
}

// ======= Demo account creation =======
el('loginBtn').addEventListener('click', async ()=>{
  const email = el('loginEmail').value.trim();
  const pass = el('loginPass').value.trim();
  el('loginError').style.display = 'none';
  if(!email || !pass){ el('loginError').innerText='Email & password wajib'; el('loginError').style.display='block'; return; }
  if(!auth){ el('loginError').innerText='Firebase tidak dikonfigurasi.'; el('loginError').style.display='block'; return; }
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  } catch(err){
    el('loginError').innerText = err.message; el('loginError').style.display='block';
  }
});

window.createDemoAccount = async function(){
  if(!auth){ alert('Firebase not configured ‚Äî membuat demo lokal saja.'); createLocalDemo(); return; }
  const email = `demo${Date.now()}@fluentbiz.demo`;
  const pass = 'password123';
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,'users',cred.user.uid),{ email, role:'seller', trialStart: serverTimestamp(), isPremium:false, integrations:{} });
    alert('Demo account created. Login dengan email: '+email+' pass: '+pass);
  } catch(e){ alert('Error creating demo: '+e.message); }
};
function createLocalDemo(){
  // fallback demo using localStorage
  localStorage.setItem('fluentbiz_demo','true');
  localStorage.setItem('fluentbiz_trialStart', new Date().toISOString());
  alert('Demo lokal dibuat. Silakan kembali ke Home dan klik Dashboard.');
  updateTrialUI();
}

// ======= Integration simulation =======
async function simulateConnect(key){
  // if Firebase configured and user logged in, save to Firestore; otherwise localStorage
  if(typeof auth !== 'undefined' && auth.currentUser){
    const uid = auth.currentUser.uid;
    const uref = doc(db,'users',uid);
    const snap = await getDoc(uref);
    const data = snap.data() || {};
    const integrations = data.integrations || {};
    integrations[key] = { demo:true, connectedAt: new Date().toISOString() };
    await updateDoc(uref,{ integrations });
    el('status-'+key).innerText = '‚úÖ Terhubung';
    setTimeout(()=>{ navigate('dashboard'); loadDashboardForRole(data.role || 'seller', data); },800);
    populateIntegrationList();
    return;
  }
  // fallback
  const store = JSON.parse(localStorage.getItem('fluentbiz_integrations') || '{}');
  store[key] = { demo:true, connectedAt:new Date().toISOString() };
  localStorage.setItem('fluentbiz_integrations', JSON.stringify(store));
  el('status-'+key).innerText = '‚úÖ Terhubung (local)';
  setTimeout(()=>{ navigate('dashboard'); loadDashboardForRole('seller'); },600);
}
window.simulateConnect = simulateConnect;

// ======= Dashboard rendering (demo analytics) =======
let salesTrendChart, platformMixChart;
function loadDashboardForRole(role, userData = null){
  if(role==='company'){
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug'];
    const revenue = [420000,480000,510000,470000,550000,620000,610000,700000];
    el('totalSales').innerText = formatRp(revenue.reduce((a,b)=>a+b,0));
    el('activeUsers').innerText = '320 employees';
    el('ordersCompleted').innerText = '1,204';
    renderLineChart('salesTrend', months, revenue, 'Revenue');
    renderDoughnut('platformMix', ['Branch A','Branch B','Branch C','Branch D'], [40,30,20,10]);
    el('recentTx').innerHTML = '<tr><td>#C001</td><td>2025-10-01</td><td>Client A</td><td>Rp 20.000.000</td></tr>';
  } else if(role==='app'){
    const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const dau = [1200,1500,1800,2100,2300,2600,3000];
    el('totalSales').innerText = dau.reduce((a,b)=>a+b,0);
    el('activeUsers').innerText = 'DAU: '+dau[dau.length-1];
    el('ordersCompleted').innerText = 'N/A';
    renderLineChart('salesTrend', days, dau, 'DAU');
    renderDoughnut('platformMix', ['Organic','Ads','Referral','Other'], [60,25,10,5]);
    el('recentTx').innerHTML = '<tr><td>#A001</td><td>2025-10-01</td><td>Player1</td><td>Rp 50.000</td></tr>';
  } else {
    const days = ['Sen','Sel','Rab','Kam','Jum','Sab','Min'];
    const sales = [12000,15000,18000,22000,26000,31000,37000];
    el('totalSales').innerText = formatRp(sales.reduce((a,b)=>a+b,0));
    el('activeUsers').innerText = '1,245';
    el('ordersCompleted').innerText = '97%';
    renderLineChart('salesTrend', days, sales, 'Sales');
    renderDoughnut('platformMix', ['Shopee','Tokopedia','Lazada','TikTok'], [45,25,20,10]);
    el('recentTx').innerHTML = '<tr><td>#S001</td><td>2025-10-01</td><td>Andi</td><td>Rp 2.000.000</td></tr>';
  }
}

function renderLineChart(canvasId, labels, data, label){
  const ctx = document.getElementById(canvasId).getContext('2d');
  if(salesTrendChart) salesTrendChart.destroy();
  salesTrendChart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{ label, data, borderColor:'#6C63FF', backgroundColor:'rgba(108,99,255,0.12)', fill:true, tension:0.35 }]},
    options:{ responsive:true, plugins:{legend:{display:false}}}
  });
}

function renderDoughnut(canvasId, labels, data){
  const ctx = document.getElementById(canvasId).getContext('2d');
  if(platformMixChart) platformMixChart.destroy();
  platformMixChart = new Chart(ctx,{ type:'doughnut', data:{ labels, datasets:[{ data }]}, options:{ responsive:true }});
}

// ======= Autopilot (demo scheduler) =======
let autopilotEnabled = false;
let autopilotIntervalId = null;
function logAutopilot(msg){
  const elLog = el('autopilotLog');
  const time = new Date().toLocaleString();
  elLog.innerHTML = `<div>[${time}] ${msg}</div>` + elLog.innerHTML;
}
async function autopilotAnalyze(){
  // This is a demo. Replace with server-side job that fetches real data, runs ML/heuristics and stores results.
  logAutopilot('Starting analysis ‚Äî fetching latest integration data...');
  // Simulate read of integrations
  const ints = JSON.parse(localStorage.getItem('fluentbiz_integrations')||'{}');
  const totalSales = Math.floor(Math.random()*50000000) + 1000000;
  const growth = (Math.random()*10).toFixed(1) + '%';
  logAutopilot(`Detected ${Object.keys(ints).length} integrations. Estimated total sales: ${formatRp(totalSales)} (growth ${growth}).`);
  // Update dashboard numbers (demo)
  el('totalSales').innerText = formatRp(totalSales);
  el('dash-sub').innerText = `Last analysis: ${new Date().toLocaleString()}`;
  // store last run time locally
  localStorage.setItem('fluentbiz_lastAutopilot', new Date().toISOString());
}

function runAutopilotNow(){ autopilotAnalyze(); }
function toggleAutopilot(){
  autopilotEnabled = !autopilotEnabled;
  el('autopilotToggle').innerText = autopilotEnabled ? 'Disable Autopilot' : 'Enable Autopilot';
  if(autopilotEnabled){
    // run every 30 minutes in demo (shorter). Replace with server-side cron for production.
    autopilotIntervalId = setInterval(autopilotAnalyze, 30*60*1000);
    logAutopilot('Autopilot enabled (demo, runs every 30 minutes).');
    autopilotAnalyze();
  } else {
    clearInterval(autopilotIntervalId);
    logAutopilot('Autopilot disabled.');
  }
}
function startAutopilotIfEnabled(){
  const stored = localStorage.getItem('fluentbiz_autopilot') === 'true';
  if(stored){ autopilotEnabled = true; toggleAutopilot(); }
}
window.runAutopilotNow = runAutopilotNow;
window.toggleAutopilot = toggleAutopilot;

// ======= Subscriptions demo logic =======
function setTrialStart(ts){
  if(typeof auth !== 'undefined' && auth.currentUser){
    // in production: set in Firestore user doc
    updateDoc(doc(db,'users',auth.currentUser.uid),{ trialStart: serverTimestamp() }).catch(()=>{});
  } else {
    localStorage.setItem('fluentbiz_trialStart', ts || new Date().toISOString());
  }
}
function getTrialStart(){
  if(typeof auth !== 'undefined' && auth.currentUser){
    // best: read from Firestore (async). Here return local fallback:
    return localStorage.getItem('fluentbiz_trialStart') || null;
  }
  return localStorage.getItem('fluentbiz_trialStart') || null;
}
function updateTrialUI(){
  const ts = getTrialStart();
  const left = ts ? daysLeftFrom(ts,7) : 7;
  el('trialDays').innerText = left;
  if(left===0){
    el('dash-sub').innerText = 'Trial expired ‚Äî upgrade untuk melanjutkan';
  }
}
function startFree(){
  if(!getTrialStart()){
    setTrialStart(new Date().toISOString());
    alert('Trial 7 hari diaktifkan (demo).');
  } else alert('Trial sudah diaktifkan.');
  updateTrialUI();
}
function startPro(){
  // Placeholder: in production open Stripe checkout or Midtrans redirect
  alert('Redirect to payment (demo) ‚Äî integrate Stripe/Midtrans in backend later.');
}
function openSubscribe(){ navigate('subscriptions'); }
window.startFree = startFree;
window.startPro = startPro;
window.openSubscribe = openSubscribe;

// ======= Settings, support and misc (demo) =======
async function saveProfile(){ alert('Profile saved (demo)'); }
async function disconnectAll(){
  if(typeof auth !== 'undefined' && auth.currentUser){
    const uid = auth.currentUser.uid;
    await updateDoc(doc(db,'users',uid),{ integrations:{} });
    el('integrationList').innerText = 'No active integrations';
    alert('All integrations disconnected (demo).');
    return;
  }
  localStorage.removeItem('fluentbiz_integrations');
  el('integrationList').innerText = 'No active integrations';
  alert('All integrations disconnected (local demo).');
}
async function sendTicket(){
  const txt = (el('supportText') || {}).value || '';
  if(!txt) return alert('Tuliskan pesan');
  if(typeof auth !== 'undefined' && auth.currentUser){
    const uid = auth.currentUser.uid;
    await addDoc(collection(db,'tickets'),{ user:uid, text:txt, status:'open', created: serverTimestamp() });
    alert('Tiket terkirim. Kami akan menindaklanjuti.');
    el('supportText').value='';
    return;
  }
  // local demo ticket
  const t = JSON.parse(localStorage.getItem('fluentbiz_tickets')||'[]');
  t.push({ text:txt, created:new Date().toISOString(), status:'open' });
  localStorage.setItem('fluentbiz_tickets', JSON.stringify(t));
  alert('Tiket terkirim (local demo).');
  el('supportText').value='';
}

// ======= Utility: populate integration list and trial on load =======
async function populateIntegrationList(){
  if(typeof auth !== 'undefined' && auth.currentUser){
    const snap = await getDoc(doc(db,'users',auth.currentUser.uid));
    const integrations = (snap.exists() && snap.data().integrations) || {};
    if(Object.keys(integrations).length===0) el('integrationList').innerText = 'No active integrations';
    else el('integrationList').innerText = Object.keys(integrations).join(', ');
    return;
  }
  const ints = JSON.parse(localStorage.getItem('fluentbiz_integrations') || '{}');
  el('integrationList').innerText = Object.keys(ints).length ? Object.keys(ints).join(', ') : 'No active integrations';
}
window.disconnectAll = disconnectAll;
window.saveProfile = saveProfile;
window.sendTicket = sendTicket;
window.populateIntegrationList = populateIntegrationList;

// ======= Init =======
updateTrialUI();
populateIntegrationList();
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FluentBiz — Smart Analytics (Premium)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --muted:#9aa6bf; --accent1:#6C63FF; --accent2:#2575FC;
      --glass: rgba(255,255,255,0.03);
      --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:linear-gradient(180deg,#071029 0%, #07112a 60%);color:#e6eefc;min-height:100vh;}
    .wrap{max-width:1280px;margin:20px auto;padding:16px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .brand{display:flex;gap:14px;align-items:center}
    .brand h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6eefc}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}

    .layout{display:grid;grid-template-columns:280px 1fr;gap:18px;margin-top:18px}
    .sidebar{background:var(--panel);border-radius:var(--radius);padding:18px;min-height:70vh;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav .item{padding:10px;border-radius:10px;cursor:pointer;color:var(--muted)}
    .nav .item.active{background:rgba(255,255,255,0.03);color:white;font-weight:700}

    .main{min-height:70vh}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .metric{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px}
    .metric .num{font-size:20px;font-weight:800}
    .grid-2{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}

    .integration-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
    .badge{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;font-size:13px}

    @media(max-width:980px){
      .layout{grid-template-columns:1fr; padding-bottom:100px}
      .metrics{grid-template-columns:repeat(1,1fr)}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div style="width:44px;height:44px;border-radius:10px;background:white;color:black;display:flex;align-items:center;justify-content:center;font-weight:800">FB</div>
        <div>
          <h1>FluentBiz — Smart Analytics</h1>
          <div class="muted" id="top-sub">Insight-driven automation for sellers, companies & apps</div>
        </div>
      </div>
      <div class="controls">
        <div id="integrationBadge" class="badge">No integrations</div>
        <button class="btn ghost" onclick="navigate('integrations')">Integrations</button>
        <button class="btn primary" id="upgradeBtn" onclick="openSubscribe()">Upgrade</button>
      </div>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Hello, <span id="userShort">Guest</span></div>
              <div class="muted" id="trialInfo">Trial: —</div>
            </div>
            <div style="text-align:right">
              <div class="muted">Plan</div>
              <div style="font-weight:800">Free</div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px" class="nav">
          <div class="item active" data-page="home" onclick="navigate('home')">Overview</div>
          <div class="item" data-page="dashboard" onclick="navigate('dashboard')">Dashboard</div>
          <div class="item" data-page="integrations" onclick="navigate('integrations')">Integrations</div>
          <div class="item" data-page="subscriptions" onclick="navigate('subscriptions')">Subscriptions</div>
          <div class="item" data-page="settings" onclick="navigate('settings')">Settings</div>
          <div class="item" data-page="support" onclick="navigate('support')">Support</div>
        </div>

        <div style="margin-top:18px">
          <div class="muted">Autopilot</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost" onclick="runAutopilotNow()">Run Now</button>
            <button class="btn primary" id="autopilotToggle" onclick="toggleAutopilot()">Enable</button>
          </div>
        </div>

        <div style="margin-top:18px" class="muted">
          <div style="font-weight:700;margin-bottom:6px">Docs & Resources</div>
          <div style="font-size:13px">• API keys<br>• Integration guides<br>• Onboarding</div>
        </div>
      </aside>

      <main class="main">
        <!-- HOME / Overview -->
        <section id="home" class="card page">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h2 style="margin:0">Overview</h2>
              <div class="muted" id="overview-sub">Unified view of all integrated sources</div>
            </div>
            <div>
              <div class="muted">View:</div>
              <select id="globalView" onchange="updateViewSelection()" class="muted">
                <option value="auto">Auto (by integration)</option>
                <option value="seller">Seller</option>
                <option value="company">Company</option>
                <option value="app">App</option>
              </select>
            </div>
          </div>

          <div style="margin-top:16px" class="metrics">
            <div class="metric">
              <div class="muted">Total Revenue</div>
              <div class="num" id="mTotalRevenue">—</div>
              <div class="muted">Last 30 days</div>
            </div>
            <div class="metric">
              <div class="muted">Active Users / Customers</div>
              <div class="num" id="mActiveUsers">—</div>
              <div class="muted">Realtime</div>
            </div>
            <div class="metric">
              <div class="muted">Conversion / Retention</div>
              <div class="num" id="mConvRet">—</div>
              <div class="muted" id="mConvSub">—</div>
            </div>
          </div>

          <div style="margin-top:16px" class="grid-2">
            <div class="card">
              <h3 style="margin:0">Primary Chart</h3>
              <canvas id="primaryChart" height="140"></canvas>
            </div>
            <div>
              <div class="card">
                <h4 style="margin:0">Top Insights</h4>
                <div id="insightsList" style="margin-top:8px" class="muted">No insights yet</div>
              </div>
              <div class="card" style="margin-top:12px">
                <h4 style="margin:0">Active Integrations</h4>
                <div id="activeIntegrations" style="margin-top:8px" class="muted">No integrations</div>
              </div>
            </div>
          </div>
        </section>

        <!-- DASHBOARD (detailed) -->
        <section id="dashboard" class="card page" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0" id="dashTitle">Dashboard</h2>
              <div class="muted" id="dashSubtitle">Detailed analytics</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
              <button class="btn primary" onclick="navigate('integrations')">Manage Integrations</button>
            </div>
          </div>

          <div style="margin-top:12px" id="dashboardContent">
            <!-- content inserted dynamically per type -->
          </div>
        </section>

        <!-- INTEGRATIONS -->
        <section id="integrations" class="card page" style="display:none">
          <h2>Integrations</h2>
          <div class="muted">Hubungkan marketplace, ERP, atau SDK aplikasi. Pilih salah satu untuk memulai.</div>

          <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
            <div class="card">
              <h4>Shopee</h4><div class="muted">OAuth / API</div>
              <div style="margin-top:8px">
                <button class="btn primary" onclick="connectExternal('seller','shopee')">Connect Shopee</button>
                <button class="btn ghost" onclick="simulateConnect('seller','shopee')">Demo connect</button>
              </div>
            </div>
            <div class="card">
              <h4>Tokopedia</h4><div class="muted">OAuth / API</div>
              <div style="margin-top:8px">
                <button class="btn primary" onclick="connectExternal('seller','tokopedia')">Connect Tokopedia</button>
                <button class="btn ghost" onclick="simulateConnect('seller','tokopedia')">Demo connect</button>
              </div>
            </div>
            <div class="card">
              <h4>ERP / CSV</h4><div class="muted">Upload CSV, or connect with ERP</div>
              <div style="margin-top:8px">
                <input type="file" id="csvUpload" accept=".csv" style="background:transparent;color:#fff"/>
                <button class="btn primary" onclick="connectExternal('company','csv')">Upload & Connect</button>
                <button class="btn ghost" onclick="simulateConnect('company','csv')">Demo connect</button>
              </div>
            </div>
            <div class="card">
              <h4>App SDK</h4><div class="muted">Integrate SDK or API</div>
              <div style="margin-top:8px">
                <button class="btn primary" onclick="connectExternal('app','sdk')">Connect App</button>
                <button class="btn ghost" onclick="simulateConnect('app','sdk')">Demo connect</button>
              </div>
            </div>
          </div>
        </section>

        <!-- SUBSCRIPTIONS -->
        <section id="subscriptions" class="card page" style="display:none">
          <h2>Subscriptions</h2>
          <div class="muted">Trial 7 hari. Untuk berlangganan gunakan Stripe (global) atau Midtrans (Indonesia).</div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div class="card" style="flex:1">
              <h3>Free Trial</h3><div class="muted">7 hari</div>
              <div style="margin-top:12px"><button class="btn primary" onclick="startFree()">Activate Trial</button></div>
            </div>
            <div class="card" style="flex:1">
              <h3>Pro</h3><div class="muted">Advanced analytics, API, SLA</div>
              <div style="margin-top:12px"><button class="btn primary" onclick="startPro()">Subscribe (Stripe)</button></div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings" class="card page" style="display:none">
          <h2>Settings</h2>
          <div class="muted">Profile & integration settings</div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <label class="muted">Name</label><input id="profileName" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff"/>
              <div style="margin-top:10px"><button class="btn primary" onclick="saveProfile()">Save</button></div>
            </div>
            <div style="flex:1">
              <h4>Connected Integrations</h4>
              <div id="integrationList" class="muted">No integrations</div>
              <div style="margin-top:12px"><button class="btn ghost" onclick="disconnectAll()">Disconnect All</button></div>
            </div>
          </div>
        </section>

        <!-- SUPPORT -->
        <section id="support" class="card page" style="display:none">
          <h2>Support</h2>
          <textarea id="supportText" rows="6" style="width:100%;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff"></textarea>
          <div style="margin-top:8px"><button class="btn primary" onclick="sendTicket()">Send Ticket</button></div>
        </section>
      </main>
    </div>
  </div>

<script type="module">
// ---------- Config (paste backend URL & Firebase in production) ----------
const BACKEND_BASE = 'https://YOUR_BACKEND_DOMAIN/api'; // replace with your backend
const STRIPE_PK = ''; // optional for frontend-only Stripe elements
const firebaseConfig = {}; // paste if using Firebase
// ------------------------------------------------------------------------

/* Optional: init Firebase if config provided (Auth & Firestore) */
let useFirebase = false;
try {
  if(firebaseConfig && Object.keys(firebaseConfig).length){
    useFirebase = true;
    // dynamic import of Firebase (only if configured)
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js');
    const { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js');
    const { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js');
    window.__FB = { initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, addDoc };
    initializeApp(firebaseConfig);
  }
} catch(e){ console.warn('Firebase not initialized', e); }

/* Helpers */
const el = id => document.getElementById(id);
function formatRp(n){ try{ return 'Rp '+Number(n).toLocaleString('id-ID'); }catch(e){ return n; } }
function zeroIf(v){ return v===undefined||v===null?0:v; }

/* Navigation */
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const elp = document.getElementById(page);
  if(elp) elp.style.display='block';
  document.querySelectorAll('.nav .item').forEach(i=>i.classList.remove('active'));
  const nav = document.querySelector(`.nav .item[data-page="${page}"]`);
  if(nav) nav.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}
window.navigate = navigate;

/* State */
let state = {
  integrations: {}, // {type:{key: {connectedAt, meta}}}
  activeView: 'auto', // auto | seller | company | app
  autopilotEnabled: false,
  trialStart: localStorage.getItem('fluentbiz_trialStart') || null,
  isPremium: false,
};

/* Initialization */
function init(){
  loadLocalState();
  renderTop();
  updateTrialUI();
  navigate('home');
  renderOverview();
  attachUI();
}
function loadLocalState(){
  const ints = JSON.parse(localStorage.getItem('fluentbiz_integrations')||'{}');
  state.integrations = ints;
  // detect default view if only one type connected
  const types = Object.values(ints).map(i=>i.type);
  if(types.length===1) state.activeView = types[0];
  el('integrationList').innerText = Object.keys(ints).length?Object.keys(ints).join(', '):'No integrations';
  el('activeIntegrations').innerText = Object.keys(ints).length?Object.keys(ints).map(k=>`${k} (${ints[k].type})`).join(', '):'No integrations';
  el('integrationBadge').innerText = Object.keys(ints).length?`${Object.keys(ints).length} integrations`:'No integrations';
}
function renderTop(){
  el('userShort').innerText = 'Guest';
  el('trialInfo').innerText = state.trialStart?`Trial started: ${new Date(state.trialStart).toLocaleDateString()}`:'Trial inactive';
}

/* UI Attach */
function attachUI(){
  // nothing heavy for now
}

/* Integrations: demo + actual */
function simulateConnect(type, key){
  const id = `${key}_${Date.now()}`;
  const store = JSON.parse(localStorage.getItem('fluentbiz_integrations')||'{}');
  store[id] = { id, key, type, connectedAt: new Date().toISOString(), meta:{demo:true} };
  localStorage.setItem('fluentbiz_integrations', JSON.stringify(store));
  state.integrations = store;
  loadLocalState();
  alert(`Connected (demo): ${key} as ${type}`);
  // After connecting, auto-navigate to relevant dashboard
  setTimeout(()=>{ determineAndShowDashboard(); },400);
}
window.simulateConnect = simulateConnect;

/* Connect External (placeholder to open OAuth or backend flow) */
function connectExternal(type,key){
  // In production: redirect to BACKEND_BASE + /integrations/connect?type=... which starts OAuth flow
  const target = `${BACKEND_BASE}/integrations/connect?type=${type}&provider=${key}`;
  alert(`Redirecting to integration flow (placeholder): ${target}`);
  // window.location.href = target;
}

/* Determine dashboard to show */
function determineAndShowDashboard(){
  // logic: if user selected manual view (globalView != auto) -> use that
  const gv = el('globalView').value;
  if(gv && gv!=='auto'){ state.activeView = gv; showDashboardFor(gv); return; }
  // auto: choose based on connected integrations
  const ints = Object.values(state.integrations || {});
  const types = new Set(ints.map(i=>i.type));
  if(types.has('seller') && !types.has('company') && !types.has('app')){ state.activeView='seller'; showDashboardFor('seller'); return; }
  if(types.has('company') && !types.has('seller') && !types.has('app')){ state.activeView='company'; showDashboardFor('company'); return; }
  if(types.has('app') && !types.has('company') && !types.has('seller')){ state.activeView='app'; showDashboardFor('app'); return; }
  // if multiple, show consolidated overview
  state.activeView='overview';
  navigate('home');
  renderOverview();
}
function updateViewSelection(){ determineAndShowDashboard(); }

/* Show dashboard for type */
function showDashboardFor(type){
  navigate('dashboard');
  el('dashTitle').innerText = type==='seller' ? 'Seller Dashboard' : type==='company' ? 'Company Dashboard' : type==='app' ? 'App Dashboard' : 'Dashboard';
  el('dashSubtitle').innerText = `View optimized for ${type}`;
  const container = el('dashboardContent');
  container.innerHTML = '';
  if(type==='seller'){
    container.innerHTML = sellerDashboardHTML();
    renderSellerDashboard();
  } else if(type==='company'){
    container.innerHTML = companyDashboardHTML();
    renderCompanyDashboard();
  } else if(type==='app'){
    container.innerHTML = appDashboardHTML();
    renderAppDashboard();
  } else {
    container.innerHTML = `<div class="card">No specialized dashboard available.</div>`;
  }
}

/* Dashboard HTML templates (concise, filled by render functions) */
function sellerDashboardHTML(){ return `
  <div class="metrics" style="margin-bottom:12px">
    <div class="metric"><div class="muted">Total Sales</div><div class="num" id="sd_totalSales">—</div><div class="muted">Last 30d</div></div>
    <div class="metric"><div class="muted">Top Product</div><div class="num" id="sd_topProd">—</div><div class="muted" id="sd_topProdSub">—</div></div>
    <div class="metric"><div class="muted">Conversion Rate</div><div class="num" id="sd_conv">—</div><div class="muted">Orders & Fulfillment</div></div>
  </div>
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px">
    <div class="card"><h4>Sales Trend</h4><canvas id="sd_salesTrend" height="120"></canvas></div>
    <div class="card"><h4>Top Products</h4><div id="sd_topProducts" class="muted">—</div></div>
  </div>
  <div class="card" style="margin-top:12px"><h4>Recent Orders</h4><table><thead><tr><th>ID</th><th>Date</th><th>Customer</th><th>Total</th></tr></thead><tbody id="sd_recentOrders"></tbody></table></div>
`;}
function companyDashboardHTML(){ return `
  <div class="metrics" style="margin-bottom:12px">
    <div class="metric"><div class="muted">Revenue</div><div class="num" id="cd_revenue">—</div><div class="muted">Last Quarter</div></div>
    <div class="metric"><div class="muted">Profit Margin</div><div class="num" id="cd_margin">—</div><div class="muted">Operational Cost</div></div>
    <div class="metric"><div class="muted">Productivity</div><div class="num" id="cd_productivity">—</div><div class="muted">Employees</div></div>
  </div>
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px">
    <div class="card"><h4>Revenue Trend</h4><canvas id="cd_revenueTrend" height="120"></canvas></div>
    <div class="card"><h4>Branch Performance</h4><div id="cd_branches" class="muted">—</div></div>
  </div>
  <div class="card" style="margin-top:12px"><h4>Latest Reports</h4><div id="cd_reports" class="muted">—</div></div>
`;}
function appDashboardHTML(){ return `
  <div class="metrics" style="margin-bottom:12px">
    <div class="metric"><div class="muted">DAU</div><div class="num" id="ad_dau">—</div><div class="muted">Today</div></div>
    <div class="metric"><div class="muted">Retention (7d)</div><div class="num" id="ad_retention">—</div><div class="muted">ARPU</div></div>
    <div class="metric"><div class="muted">Crashes</div><div class="num" id="ad_crash">—</div><div class="muted">Stability</div></div>
  </div>
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px">
    <div class="card"><h4>Engagement Trend</h4><canvas id="ad_engage" height="120"></canvas></div>
    <div class="card"><h4>Acquisition Mix</h4><div id="ad_acq" class="muted">—</div></div>
  </div>
  <div class="card" style="margin-top:12px"><h4>Recent Events</h4><div id="ad_events" class="muted">—</div></div>
`;}

/* Renderers for each dashboard — demo data, but show where to call backend */
let primaryChart;
function renderSellerDashboard(){
  // TRY to fetch summary from backend:
  fetch(`${BACKEND_BASE}/summary?seller=true`).then(r=>r.json()).then(data=>{
    // if backend present and returns expected shape, use it; otherwise fallback to demo
    if(data && data.totalSales!==undefined){
      fillSellerFromBackend(data);
    } else fillSellerDemo();
  }).catch(()=>fillSellerDemo());
}
function fillSellerFromBackend(d){
  el('sd_totalSales').innerText = formatRp(d.totalSales);
  el('sd_topProd').innerText = d.topProduct || '—';
  el('sd_conv').innerText = d.conversionRate || '—';
  // charts
  const labels = d.trend.labels; const series = d.trend.series;
  renderLine('sd_salesTrend', labels, series, 'Revenue');
  // recent orders
  el('sd_recentOrders').innerHTML = (d.recent || []).map(tx=>`<tr><td>${tx.id}</td><td>${tx.date}</td><td>${tx.customer}</td><td>${formatRp(tx.total)}</td></tr>`).join('');
  el('sd_topProducts').innerText = (d.topProducts||[]).map(p=>`${p.name} (${p.sales})`).join('\n');
}
function fillSellerDemo(){
  const sales = [12000,15000,18000,21000,26000,30000,34000];
  el('sd_totalSales').innerText = formatRp(sales.reduce((a,b)=>a+b,0));
  el('sd_topProd').innerText = 'Produk A';
  el('sd_conv').innerText = '3.4%';
  renderLine('sd_salesTrend',['Sen','Sel','Rab','Kam','Jum','Sab','Min'], sales, 'Sales');
  el('sd_recentOrders').innerHTML = `
    <tr><td>#S001</td><td>2025-10-05</td><td>Rini</td><td>${formatRp(125000)}</td></tr>
    <tr><td>#S002</td><td>2025-10-04</td><td>Budi</td><td>${formatRp(250000)}</td></tr>
  `;
  el('sd_topProducts').innerHTML = `<div class="muted">Produk A — 1.2k sold<br>Produk B — 720 sold</div>`;
}

function renderCompanyDashboard(){
  fetch(`${BACKEND_BASE}/summary?company=true`).then(r=>r.json()).then(data=>{
    if(data && data.revenue!==undefined) fillCompanyFromBackend(data); else fillCompanyDemo();
  }).catch(()=>fillCompanyDemo());
}
function fillCompanyFromBackend(d){
  el('cd_revenue').innerText = formatRp(d.revenue);
  el('cd_margin').innerText = d.margin+'%';
  renderLine('cd_revenueTrend', d.trend.labels, d.trend.series, 'Revenue');
  el('cd_branches').innerText = d.branches.map(b=>`${b.name}: ${formatRp(b.revenue)}`).join('\n');
}
function fillCompanyDemo(){
  const rev = [420000,480000,510000,470000,550000,620000];
  el('cd_revenue').innerText = formatRp(rev.reduce((a,b)=>a+b,0));
  el('cd_margin').innerText = '18%';
  renderLine('cd_revenueTrend',['Jan','Feb','Mar','Apr','May','Jun'], rev, 'Revenue');
  el('cd_branches').innerText = 'Jakarta: Rp 1.2M\nBandung: Rp 580k\nSurabaya: Rp 420k';
}

function renderAppDashboard(){
  fetch(`${BACKEND_BASE}/summary?app=true`).then(r=>r.json()).then(data=>{
    if(data && data.dau!==undefined) fillAppFromBackend(data); else fillAppDemo();
  }).catch(()=>fillAppDemo());
}
function fillAppFromBackend(d){
  el('ad_dau').innerText = d.dau;
  el('ad_retention').innerText = d.retention+'%';
  renderLine('ad_engage', d.trend.labels, d.trend.series, 'Engagement');
}
function fillAppDemo(){
  const dau = [1200,1500,1800,2100,2300,2600,3000];
  el('ad_dau').innerText = dau[dau.length-1];
  el('ad_retention').innerText = '28%';
  renderLine('ad_engage',['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], dau, 'DAU');
  el('ad_events').innerText = 'No recent critical events';
}

/* Chart util */
let charts = {};
function renderLine(id, labels, data, label){
  const ctx = document.getElementById(id).getContext('2d');
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label, data, fill:true, tension:0.3, borderColor: '#6C63FF', backgroundColor: 'rgba(108,99,255,0.08)' }]},
    options: { plugins:{legend:{display:false}}, responsive:true }
  });
}

/* Overview primary chart (consolidated) */
function renderOverview(){
  // sample consolidated numbers from connected sources
  const ints = Object.values(state.integrations || {});
  const hasSeller = ints.some(i=>i.type==='seller');
  const hasCompany = ints.some(i=>i.type==='company');
  const hasApp = ints.some(i=>i.type==='app');

  // demo logic to choose primary dataset
  if(hasSeller && !hasCompany && !hasApp){
    state.activeView='seller'; showDashboardFor('seller'); return;
  }
  if(hasCompany && !hasSeller && !hasApp){ state.activeView='company'; showDashboardFor('company'); return; }
  if(hasApp && !hasSeller && !hasCompany){ state.activeView='app'; showDashboardFor('app'); return; }

  // else show consolidated overview
  const labels = ['W1','W2','W3','W4'];
  const series = [120000,160000,200000,240000];
  if(primaryChart) primaryChart.destroy();
  const ctx = document.getElementById('primaryChart').getContext('2d');
  primaryChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Total', data: series }]},
    options:{ plugins:{legend:{display:false}}, responsive:true }
  });
  // fill overview metrics
  el('mTotalRevenue').innerText = formatRp(series.reduce((a,b)=>a+b,0));
  el('mActiveUsers').innerText = '3,420';
  el('mConvRet').innerText = 'Avg conv 2.8%';
  el('mConvSub').innerText = 'Retention 28%';
  el('insightsList').innerText = 'Autopilot: No anomalies detected';
}

/* Subscriptions & Trial */
function updateTrialUI(){
  const ts = state.trialStart;
  if(!ts){ el('trialInfo').innerText = 'Trial inactive'; el('trialInfo').style.color='var(--muted)'; return; }
  const left = Math.max(0, 7 - Math.floor((Date.now() - new Date(ts))/ (1000*60*60*24)));
  el('trialInfo').innerText = `Trial: ${left} day(s) left`;
  if(left===0){ el('trialInfo').innerText = 'Trial expired'; }
}
function startFree(){
  if(!state.trialStart){ state.trialStart = new Date().toISOString(); localStorage.setItem('fluentbiz_trialStart', state.trialStart); updateTrialUI(); alert('Trial 7 hari diaktifkan (demo)'); }
  else alert('Trial sudah aktif');
}
function startPro(){
  // in production: call backend to create Stripe checkout session
  const checkoutUrl = `${BACKEND_BASE}/checkout/create-session`;
  alert(`Redirect to checkout (placeholder): ${checkoutUrl}`);
  // window.location.href = checkoutUrl;
}

/* Autopilot: prefer server-side */
function runAutopilotNow(){
  // Try backend trigger
  fetch(`${BACKEND_BASE}/autopilot/run`, { method:'POST' }).then(r=>r.json()).then(res=>{
    alert('Autopilot run triggered (backend). See logs.');
  }).catch(err=>{
    // fallback demo
    alert('Backend not available — running demo autopilot.');
    demoAutopilot();
  });
}
function toggleAutopilot(){
  state.autopilotEnabled = !state.autopilotEnabled;
  el('autopilotToggle').innerText = state.autopilotEnabled ? 'Disable' : 'Enable';
  localStorage.setItem('fluentbiz_autopilot', state.autopilotEnabled?'true':'false');
}
function demoAutopilot(){
  const ints = Object.values(state.integrations || {});
  const total = Math.floor(Math.random()*1000000)+500000;
  el('insightsList').innerText = `Autopilot: Estimated total across integrations ${formatRp(total)} — trend up`;
  el('mTotalRevenue').innerText = formatRp(total);
}

/* Misc */
function exportCSV(){ alert('Export CSV (placeholder). Connect backend for real export.'); }
function openSubscribe(){ navigate('subscriptions'); }
function saveProfile(){ alert('Profile saved (demo)'); }
function disconnectAll(){ localStorage.removeItem('fluentbiz_integrations'); state.integrations={}; loadLocalState(); alert('Disconnected all (demo)'); renderOverview(); }
function sendTicket(){ const v = el('supportText').value || ''; if(!v) return alert('Tuliskan pesan'); const t = JSON.parse(localStorage.getItem('fluentbiz_tickets')||'[]'); t.push({text:v, created:new Date().toISOString()}); localStorage.setItem('fluentbiz_tickets', JSON.stringify(t)); alert('Ticket terkirim (demo)'); el('supportText').value=''; }

/* Populate initial data & UI events */
init();

// When page loads, try auto-detect dashboard
setTimeout(()=>{ determineAndShowDashboard(); },300);

</script>
</body>
</html>
